# Midscene.js + Playwright é›†æˆæŒ‡å—

## ğŸ¯ ä¸ºä»€ä¹ˆé€‰æ‹© Playwright é›†æˆæ¨¡å¼ï¼Ÿ

åŸºäºæ‚¨æä¾›çš„ Midscene.js å®˜æ–¹æ–‡æ¡£ï¼Œ**Playwright é›†æˆ + ç¼“å­˜** æ˜¯æ„å»º AI é©±åŠ¨å‰ç«¯ç«¯åˆ°ç«¯è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶çš„æœ€ä½³é€‰æ‹©ï¼š

### ğŸš€ æ ¸å¿ƒä¼˜åŠ¿

1. **âš¡ æ€§èƒ½ä¼˜åŒ–**ï¼šç¼“å­˜å°†æ‰§è¡Œæ—¶é—´ä» 51ç§’ é™ä½åˆ° 28ç§’
2. **ğŸ”§ æˆç†Ÿç”Ÿæ€**ï¼šåˆ©ç”¨ Playwright å®Œæ•´çš„æµ‹è¯•æ¡†æ¶èƒ½åŠ›
3. **ğŸ’° æˆæœ¬æ§åˆ¶**ï¼šå¤§å¹…å‡å°‘ AI æ¨¡å‹è°ƒç”¨æ¬¡æ•°
4. **ğŸ“Š ä¸°å¯ŒæŠ¥å‘Š**ï¼šå†…ç½®å¯è§†åŒ–æµ‹è¯•æŠ¥å‘Š
5. **ğŸ› ï¸ è°ƒè¯•å‹å¥½**ï¼šå¼ºå¤§çš„è°ƒè¯•å’Œå¼€å‘å·¥å…·
6. **ğŸ”„ å¹¶è¡Œæ‰§è¡Œ**ï¼šæ”¯æŒå¤šæµ‹è¯•ç”¨ä¾‹å¹¶è¡Œè¿è¡Œ

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Playwright æµ‹è¯•æ¡†æ¶                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æµ‹è¯•ç”¨ä¾‹ (TypeScript/JavaScript)                           â”‚
â”‚    â”œâ”€â”€ test.beforeEach() - æµ‹è¯•å‰ç½®æ¡ä»¶                     â”‚
â”‚    â”œâ”€â”€ test.step() - æµ‹è¯•æ­¥éª¤ç»„ç»‡                           â”‚
â”‚    â””â”€â”€ expect() - æ–­è¨€éªŒè¯                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Midscene.js Fixture                                       â”‚
â”‚    â”œâ”€â”€ ai() - é€šç”¨ AI äº¤äº’                                  â”‚
â”‚    â”œâ”€â”€ aiTap() - AI ç‚¹å‡»æ“ä½œ                                â”‚
â”‚    â”œâ”€â”€ aiInput() - AI è¾“å…¥æ“ä½œ                              â”‚
â”‚    â”œâ”€â”€ aiQuery() - AI æ•°æ®æå–                              â”‚
â”‚    â”œâ”€â”€ aiAssert() - AI æ–­è¨€éªŒè¯                             â”‚
â”‚    â””â”€â”€ logScreenshot() - æˆªå›¾è®°å½•                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¼“å­˜ç³»ç»Ÿ (MIDSCENE_CACHE=1)                               â”‚
â”‚    â”œâ”€â”€ ä»»åŠ¡è§„åˆ’ç»“æœç¼“å­˜                                      â”‚
â”‚    â”œâ”€â”€ å…ƒç´ å®šä½ XPath ç¼“å­˜                                   â”‚
â”‚    â””â”€â”€ è‡ªåŠ¨ç¼“å­˜å¤±æ•ˆå¤„ç†                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  AI æ¨¡å‹æœåŠ¡ (é˜¿é‡Œäº‘é€šä¹‰åƒé—®)                                â”‚
â”‚    â”œâ”€â”€ qwen-vl-max-latest                                  â”‚
â”‚    â”œâ”€â”€ è§†è§‰ç†è§£èƒ½åŠ›                                          â”‚
â”‚    â””â”€â”€ ä¸­æ–‡æŒ‡ä»¤ä¼˜åŒ–                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒé…ç½®

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
export OPENAI_BASE_URL="https://dashscope.aliyuncs.com/compatible-mode/v1"
export OPENAI_API_KEY="your-api-key"
export MIDSCENE_MODEL_NAME="qwen-vl-max-latest"
export MIDSCENE_USE_QWEN_VL=1
export MIDSCENE_CACHE=1  # å¯ç”¨ç¼“å­˜
export BASE_URL="https://your-app.com"
```

### 2. å®‰è£…ä¾èµ–

```bash
# åœ¨ js_driver ç›®å½•
cd js_driver
npm install @midscene/web @playwright/test playwright tsx

# å®‰è£… Playwright æµè§ˆå™¨
npx playwright install chromium
```

### 3. è¿è¡Œæµ‹è¯•

```bash
# åŸºç¡€è¿è¡Œ
./run_playwright_tests.sh

# ä¸åŒè¿è¡Œæ¨¡å¼
./run_playwright_tests.sh cache    # ç¼“å­˜æ¨¡å¼
./run_playwright_tests.sh headed   # æœ‰å¤´æ¨¡å¼
./run_playwright_tests.sh debug    # è°ƒè¯•æ¨¡å¼
./run_playwright_tests.sh p0       # P0 ä¼˜å…ˆçº§æµ‹è¯•
./run_playwright_tests.sh report   # æŸ¥çœ‹æŠ¥å‘Š
```

## ğŸ“ æµ‹è¯•ç”¨ä¾‹ç¼–å†™

### åŸºç¡€ç»“æ„

```typescript
import { test, expect } from './fixture';

test.beforeEach(async ({ page }) => {
  await page.setViewportSize({ width: 1280, height: 720 });
  await page.goto(process.env.BASE_URL!);
  await page.waitForLoadState('networkidle');
});

test.describe('åŠŸèƒ½æ¨¡å—', () => {
  test('å…·ä½“æµ‹è¯•åœºæ™¯', async ({
    ai,           // é€šç”¨ AI äº¤äº’
    aiQuery,      // AI æ•°æ®æå–  
    aiAssert,     // AI æ–­è¨€
    aiInput,      // AI è¾“å…¥
    aiTap,        // AI ç‚¹å‡»
    aiWaitFor,    // AI ç­‰å¾…
    logScreenshot // æˆªå›¾è®°å½•
  }) => {
    // å¯ç”¨ç¼“å­˜
    process.env.MIDSCENE_CACHE = '1';
    
    // æµ‹è¯•æ­¥éª¤
    await test.step('æ­¥éª¤1: ç”¨æˆ·ç™»å½•', async () => {
      await aiInput('admin', 'ç”¨æˆ·åè¾“å…¥æ¡†');
      await aiInput('password', 'å¯†ç è¾“å…¥æ¡†');
      await aiTap('ç™»å½•æŒ‰é’®');
      await aiAssert('ç”¨æˆ·å·²æˆåŠŸç™»å½•');
    });
    
    // è®°å½•å…³é”®çŠ¶æ€
    await logScreenshot('ç™»å½•æˆåŠŸ', { content: 'ç”¨æˆ·ç™»å½•æµç¨‹å®Œæˆ' });
  });
});
```

### ğŸ¯ AI æŒ‡ä»¤æœ€ä½³å®è·µ

```typescript
// âœ… å¥½çš„æŒ‡ä»¤ - å…·ä½“æ˜ç¡®
await ai('ç‚¹å‡»é¡µé¢å³ä¸Šè§’çš„è“è‰²"ç™»å½•"æŒ‰é’®');
await aiInput('æµ‹è¯•æ•°æ®', 'æ ‡æœ‰"ç”¨æˆ·å"çš„è¾“å…¥æ¡†');
await aiAssert('é¡µé¢æ˜¾ç¤º"æ¬¢è¿å›æ¥"çš„é—®å€™è¯­');

// âŒ é¿å…çš„æŒ‡ä»¤ - æ¨¡ç³Šä¸æ¸…  
await ai('ç‚¹å‡»æŒ‰é’®');
await aiInput('æ•°æ®', 'è¾“å…¥æ¡†');
await aiAssert('é¡µé¢æ­£å¸¸');
```

### ğŸ“Š æ•°æ®æå–ç¤ºä¾‹

```typescript
// æå–ç»“æ„åŒ–æ•°æ®
const products = await aiQuery<Array<{
  name: string;
  price: number;
  rating: number;
}>>('è·å–äº§å“åˆ—è¡¨ä¸­æ‰€æœ‰å•†å“çš„åç§°ã€ä»·æ ¼å’Œè¯„åˆ†');

// æå–å•ä¸ªå€¼
const totalPrice = await agent.aiNumber('è´­ç‰©è½¦ä¸­çš„æ€»é‡‘é¢æ˜¯å¤šå°‘ï¼Ÿ');
const userName = await agent.aiString('å½“å‰ç™»å½•ç”¨æˆ·çš„ç”¨æˆ·åæ˜¯ä»€ä¹ˆï¼Ÿ');
const isLoggedIn = await agent.aiBoolean('ç”¨æˆ·æ˜¯å¦å·²ç»ç™»å½•ï¼Ÿ');
```

## ğŸ—‚ï¸ ç¼“å­˜ç­–ç•¥è¯¦è§£

### ç¼“å­˜å†…å®¹

1. **ä»»åŠ¡è§„åˆ’ç»“æœ**: `ai`ã€`aiAction` æ–¹æ³•çš„æ‰§è¡Œè®¡åˆ’
2. **å…ƒç´ å®šä½æ•°æ®**: `aiTap`ã€`aiInput` ç­‰æ–¹æ³•çš„ XPath ä¿¡æ¯
3. **ä¸ç¼“å­˜å†…å®¹**: `aiQuery`ã€`aiAssert`ã€`aiBoolean` ç­‰æŸ¥è¯¢ç±»æ–¹æ³•

### ç¼“å­˜å‘½ä¸­æ¡ä»¶

```typescript
const agent = new PlaywrightAgent(page, {
  cacheId: 'my-test-cache', // è®¾ç½®ç¼“å­˜æ ‡è¯†
});

// ç›¸åŒçš„æŒ‡ä»¤ + ç›¸åŒçš„é¡µé¢çŠ¶æ€ = ç¼“å­˜å‘½ä¸­
await agent.aiAction('ç‚¹å‡»æœç´¢æŒ‰é’®'); // ç¬¬ä¸€æ¬¡ï¼šè°ƒç”¨ AI
await agent.aiAction('ç‚¹å‡»æœç´¢æŒ‰é’®'); // ç¬¬äºŒæ¬¡ï¼šä½¿ç”¨ç¼“å­˜
```

### ç¼“å­˜æ–‡ä»¶ä½ç½®

```
./midscene_run/cache/
â”œâ”€â”€ my-test-cache.cache.yaml
â”œâ”€â”€ agent-features-playwright.cache.yaml
â””â”€â”€ ...
```

### ç¼“å­˜æ€§èƒ½å¯¹æ¯”

| æ¨¡å¼ | æ‰§è¡Œæ—¶é—´ | AI è°ƒç”¨æ¬¡æ•° | æˆæœ¬ |
|------|----------|-------------|------|
| æ— ç¼“å­˜ | 51ç§’ | 15æ¬¡ | é«˜ |
| **ç¼“å­˜æ¨¡å¼** | **28ç§’** | **3æ¬¡** | **ä½** |

## ğŸ“Š æµ‹è¯•æŠ¥å‘Š

### æŠ¥å‘Šç±»å‹

1. **åˆå¹¶æŠ¥å‘Š** (é»˜è®¤): æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆä¸€ä¸ªæŠ¥å‘Š
2. **åˆ†ç¦»æŠ¥å‘Š**: æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ç‹¬ç«‹æŠ¥å‘Š

```typescript
// playwright.config.ts
reporter: [
  ['list'], 
  ['@midscene/web/playwright-reporter', { 
    type: 'merged' // æˆ– 'separate'
  }]
]
```

### æŠ¥å‘Šå†…å®¹

- ğŸ“¸ æ¯ä¸ªæ­¥éª¤çš„é¡µé¢æˆªå›¾
- ğŸ¤– AI æ“ä½œçš„è¯¦ç»†è¿‡ç¨‹
- â±ï¸ æ‰§è¡Œæ—¶é—´å’Œæ€§èƒ½æ•°æ®
- ğŸ¯ ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡
- âŒ å¤±è´¥åŸå› å’Œè°ƒè¯•ä¿¡æ¯

## ğŸ› ï¸ è°ƒè¯•æŠ€å·§

### 1. å¯ç”¨è°ƒè¯•æ¨¡å¼

```bash
# è°ƒè¯•æ¨¡å¼è¿è¡Œ
./run_playwright_tests.sh debug

# æˆ–è€…ç›´æ¥ä½¿ç”¨ Playwright
npx playwright test --debug
```

### 2. æŸ¥çœ‹ç¼“å­˜æ—¥å¿—

```bash
export DEBUG=midscene:cache:*
./run_playwright_tests.sh
```

### 3. æ‰‹åŠ¨æ¸…ç†ç¼“å­˜

```bash
# åˆ é™¤æ‰€æœ‰ç¼“å­˜
rm -rf ./midscene_run/cache/

# åˆ é™¤ç‰¹å®šæµ‹è¯•çš„ç¼“å­˜
rm ./midscene_run/cache/my-test-cache.cache.yaml
```

### 4. æ€§èƒ½åˆ†æ

```typescript
test('æ€§èƒ½æµ‹è¯•', async ({ ai }) => {
  const startTime = Date.now();
  
  // æ‰§è¡Œæµ‹è¯•æ“ä½œ
  await ai('æ‰§è¡Œå¤æ‚æ“ä½œ');
  
  const endTime = Date.now();
  console.log(`æ‰§è¡Œæ—¶é—´: ${endTime - startTime}ms`);
});
```

## ğŸš¨ å¸¸è§é—®é¢˜æ’æŸ¥

### 1. ç¼“å­˜æœªç”Ÿæ•ˆ

**åŸå› **: 
- æœªè®¾ç½® `MIDSCENE_CACHE=1`
- æœªè®¾ç½® `cacheId`
- é¡µé¢ç»“æ„å‘ç”Ÿå˜åŒ–

**è§£å†³**:
```bash
export MIDSCENE_CACHE=1
export DEBUG=midscene:cache:*
```

### 2. AI æ¨¡å‹è°ƒç”¨å¤±è´¥

**åŸå› **: API å¯†é’¥æˆ–é…ç½®é”™è¯¯

**è§£å†³**:
```bash
# æ£€æŸ¥é…ç½®
echo $OPENAI_API_KEY
echo $OPENAI_BASE_URL

# é‡æ–°è®¾ç½®
export OPENAI_API_KEY="sk-your-key"
```

### 3. å…ƒç´ å®šä½å¤±è´¥

**åŸå› **: é¡µé¢ç»“æ„å˜åŒ–å¯¼è‡´ç¼“å­˜å¤±æ•ˆ

**è§£å†³**: ç¼“å­˜ä¼šè‡ªåŠ¨å¤±æ•ˆï¼ŒAI é‡æ–°å®šä½å…ƒç´ 

### 4. æµ‹è¯•æ‰§è¡Œç¼“æ…¢

**åŸå› **: 
- æœªå¯ç”¨ç¼“å­˜
- é¡µé¢åŠ è½½ç¼“æ…¢
- AI æŒ‡ä»¤ä¸å¤Ÿç²¾ç¡®

**è§£å†³**:
- å¯ç”¨ç¼“å­˜: `MIDSCENE_CACHE=1`
- ä¼˜åŒ–æŒ‡ä»¤ç²¾ç¡®åº¦
- ä½¿ç”¨ `aiWaitFor` ç­‰å¾…é¡µé¢å°±ç»ª

## ğŸ¯ æœ€ä½³å®è·µæ€»ç»“

1. **âœ… å§‹ç»ˆå¯ç”¨ç¼“å­˜**: `MIDSCENE_CACHE=1`
2. **âœ… è®¾ç½®ç¼“å­˜æ ‡è¯†**: ä½¿ç”¨æœ‰æ„ä¹‰çš„ `cacheId`
3. **âœ… ç²¾ç¡®çš„ AI æŒ‡ä»¤**: åŒ…å«è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯
4. **âœ… åˆç†çš„æµ‹è¯•ç»„ç»‡**: ä½¿ç”¨ `test.step()` ç»„ç»‡æ­¥éª¤
5. **âœ… å…³é”®çŠ¶æ€æˆªå›¾**: ä½¿ç”¨ `logScreenshot()` è®°å½•
6. **âœ… é€‚å½“çš„ç­‰å¾…ç­–ç•¥**: ä½¿ç”¨ `aiWaitFor()` è€Œä¸æ˜¯å›ºå®šå»¶æ—¶
7. **âœ… é”™è¯¯å¤„ç†**: ä½¿ç”¨ try-catch å¤„ç†å¼‚å¸¸æƒ…å†µ

## ğŸ”® è¿›é˜¶åŠŸèƒ½

### è‡ªå®šä¹‰æ“ä½œ

```typescript
import { defineAction } from '@midscene/core/device';

const customAction = defineAction({
  name: 'multiClick',
  description: 'è¿ç»­ç‚¹å‡»åŒä¸€å…ƒç´ ',
  paramSchema: z.object({
    locate: getMidsceneLocationSchema(),
    count: z.number()
  }),
  async call(param) {
    // è‡ªå®šä¹‰å®ç°
  }
});

const agent = new PlaywrightAgent(page, {
  customActions: [customAction]
});
```

### å¹¶è¡Œæµ‹è¯•

```typescript
// playwright.config.ts
export default defineConfig({
  fullyParallel: true,
  workers: process.env.CI ? 1 : 4, // æœ¬åœ°å¹¶è¡Œæ‰§è¡Œ
});
```

è¿™ä¸ªåŸºäº Playwright é›†æˆçš„æ–¹æ¡ˆä¸ºæ‚¨æä¾›äº†ä¸€ä¸ªå®Œæ•´ã€é«˜æ•ˆã€å¯ç»´æŠ¤çš„ AI é©±åŠ¨æµ‹è¯•æ¡†æ¶ï¼ğŸ‰